description: Naia distribution and release pipeline

formats:
  flatpak:
    app_id: io.nextain.naia
    manifest: flatpak/io.nextain.naia.yml
    flathub_manifest: flatpak/flathub/io.nextain.naia.yml
    metainfo: flatpak/io.nextain.naia.metainfo.xml
    desktop: flatpak/io.nextain.naia.desktop
    shared_modules: flatpak/shared-modules/ (git submodule from flathub/shared-modules)
    runtime: org.gnome.Platform//49
    sdk_extensions:
      - org.freedesktop.Sdk.Extension.rust-stable
      - org.freedesktop.Sdk.Extension.node22
    status: working
    critical_notes:
      - "MUST use 'npx tauri build --no-bundle' (NOT cargo build --release)"
      - "cargo build --release causes white screen — WebKitGTK asset protocol not configured"
      - "tauri.conf.flatpak.json overrides beforeBuildCommand to empty (frontend built separately)"
      - "deep-link scheme: x-scheme-handler/naia (NOT nanos)"
      - "@node-llama-cpp excluded from bundle (rm -rf after npm install) — saves ~650MB"
      - "OpenClaw bundled at /app/lib/naia-os/openclaw/"
      - "Node bundled at /app/bin/node"
      - "pnpm not in PATH — use npx pnpm, npx tauri"
      - "Claude Code terminal cannot flatpak install — use desktop terminal"

  appimage:
    built_by: tauri build
    status: working

  deb:
    built_by: tauri build
    status: working

  rpm:
    built_by: tauri build
    status: working

  iso:
    builder: ublue-os/titanoboa@main
    type: live ISO (squashfs + ephemeral overlay)
    base_image: ghcr.io/nextain/naia-os:latest
    output_name: naia-os-live-amd64.iso
    status: working
    hook: installer/hook-post-rootfs.sh
    flatpaks: installer/flatpaks (Chrome, Discord — baked into squashfs)
    customizations:
      - Anaconda installer + Naia branding (sidebar, topbar, CSS)
      - Anaconda profile (BTRFS + zstd, Naia CSS)
      - KDE taskbar pin (Naia Shell)
      - fcitx5 hangul default config (Korean input)
      - Live wallpaper
      - Live session warning dialog (kdialog, Korean)
    notes:
      - GHCR package must be public for image pull
      - Hook clones repo via git (repo must be public)
      - Titanoboa GRUB is hardcoded (label from os-release PRETTY_NAME)
      - CDLABEL is always 'titanoboa_boot' (not customizable)
      - Pre-installed flatpaks survive reboot (in squashfs), user data does not
      - ISO uploaded as Actions Artifact (too large for Release)
      - Artifact retention: 30 days
      - CHECKSUM file uploaded to Release draft

release:
  current_version: v0.1.0
  assets:
    - Naia.Shell_0.1.0_amd64.AppImage
    - Naia.Shell_0.1.0_amd64.deb
    - Naia.Shell-0.1.0-1.x86_64.rpm
    - Naia-Shell-x86_64.flatpak
    - SHA256SUMS
  download_page: https://naia.nextain.io/download
  download_page_repo: naia.nextain.io/

workflows:
  release_app: .github/workflows/release-app.yml
  build_os_image: .github/workflows/build.yml
  generate_iso: .github/workflows/iso.yml

ci_pipeline:
  # Parallel
  build_linux: "tauri build → AppImage, DEB, RPM"
  build_flatpak: "flatpak-builder → flatpak build-bundle"
  # Sequential (depends on both above)
  release: "download artifacts → SHA256SUMS → GitHub Release"
  # Triggered by release success
  generate_iso: "OCI image → bootable ISO (needs GHCR image first)"

local_build:
  flatpak:
    prerequisites:
      - flatpak-builder installed
      - "org.gnome.Platform//49 + Sdk//49"
      - org.freedesktop.Sdk.Extension.rust-stable
      - org.freedesktop.Sdk.Extension.node22
    commands:
      clean: "rm -rf flatpak-repo build-dir .flatpak-builder"
      build: "flatpak-builder --force-clean --disable-rofiles-fuse --repo=flatpak-repo build-dir flatpak/io.nextain.naia.yml"
      bundle: "flatpak build-bundle flatpak-repo Naia-Shell-x86_64.flatpak io.nextain.naia"
      upload: "gh release upload v0.1.0 Naia-Shell-x86_64.flatpak --clobber"
    script: "bash scripts/local-reinstall-run-naia-flatpak.sh (bundle + uninstall + install + run)"
    important_notes:
      - MUST clean flatpak-repo before build to avoid 'invalid rdev' corruption
      - Old app-id artifacts (com.naia.shell) can corrupt the ostree repo
      - CI workflow includes rm -rf cleanup step before flatpak-builder
      - "NEVER use cargo build --release for Flatpak — causes white screen"
      - "ALWAYS use npx tauri build --no-bundle --config src-tauri/tauri.conf.flatpak.json"

flathub_submission:
  guide: docs/flathub-submission-guide.md
  status: not_started
  blockers:
    - cargo-sources.json not generated
    - node-sources-agent.json not generated
    - node-sources-shell.json not generated
  steps:
    1: Generate offline dependency JSONs (flatpak-builder-tools)
    2: Finalize flathub manifest (remove --share=network, add commit SHA)
    3: Fork flathub/flathub on GitHub
    4: Create PR with manifest + dependency files
    5: Address reviewer feedback

os_image:
  builder: blue-build/github-action@v1
  base: ghcr.io/ublue-os/bazzite (Fedora Atomic)
  recipe: recipes/recipe.yml
  scripts:
    - config/scripts/install-pnpm.sh
    - config/scripts/install-naia-shell.sh (downloads AppImage from GitHub Release)
    - config/scripts/branding.sh (os-release → Naia, URLs → naia.nextain.io)
    - config/scripts/setup-openclaw.sh (gateway systemd service, runs on first boot)
  deployed_files:
    - config/files/usr/share/applications/naia-shell.desktop (app launcher)
    - config/files/usr/etc/xdg/autostart/naia-shell.desktop (login autostart)
    - config/files/usr/lib/systemd/user/naia-gateway.service (gateway daemon)
    - config/files/usr/bin/naia-gateway-wrapper (gateway runner script)
  registry: ghcr.io/nextain/naia-os
  tags: [latest, YYYYMMDD, fedora-version, YYYYMMDD-fedora-version]
  status: working
  notes:
    - Recipe name must be lowercase (Docker stage name constraint)
    - Checkout needs submodules:true for shared-modules
    - GHCR package visibility must be public (org setting)
    - Naia Shell autostart on login via XDG autostart entry

bootable_usb:
  create: "sudo dd if=naia-os-live-amd64.iso of=/dev/sdX bs=4M status=progress oflag=sync"
  verify: "lsblk /dev/sdX -o NAME,SIZE,LABEL,FSTYPE (label should be titanoboa_boot)"
  behavior:
    - Live session = read-only squashfs + RAM overlay (ephemeral)
    - Pre-installed apps (Chrome, Discord, Naia Shell) persist across boots
    - User data, settings, AI conversations are lost on reboot
    - "Install to Hard Drive" for permanent installation
  notes:
    - Must unmount USB first (sudo umount /dev/sdX1)
    - ISO is hybrid — works for both UEFI and legacy BIOS boot
    - CDLABEL is titanoboa_boot (hardcoded by titanoboa)
