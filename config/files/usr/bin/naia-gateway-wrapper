#!/usr/bin/env bash
set -euo pipefail

# Naia Gateway Wrapper
# Runs OpenClaw Gateway with Naia-safe defaults
# OpenClaw is installed system-wide at /usr/share/naia/openclaw/

SYSTEM_OPENCLAW="/usr/share/naia/openclaw"
USER_OPENCLAW="${HOME}/.naia/openclaw"
OPENCLAW_BIN="${SYSTEM_OPENCLAW}/node_modules/.bin/openclaw"
NODE_BIN="$(command -v node || echo /usr/bin/node)"

# Fall back to user-local install if system install not found
if [ ! -x "${OPENCLAW_BIN}" ] && [ -x "${USER_OPENCLAW}/node_modules/.bin/openclaw" ]; then
    OPENCLAW_BIN="${USER_OPENCLAW}/node_modules/.bin/openclaw"
fi

if [ ! -x "${OPENCLAW_BIN}" ]; then
    echo "ERROR: OpenClaw not found at ${SYSTEM_OPENCLAW} or ${USER_OPENCLAW}" >&2
    exit 1
fi

# Ensure Node.js 22+
NODE_VERSION=$("${NODE_BIN}" -v 2>/dev/null | sed 's/v//' | cut -d. -f1)
if [ "${NODE_VERSION:-0}" -lt 22 ]; then
    if [ -f "${HOME}/.config/nvm/nvm.sh" ]; then
        export NVM_DIR="${HOME}/.config/nvm"
        # shellcheck source=/dev/null
        . "${NVM_DIR}/nvm.sh" --no-use
        NODE_BIN="${NVM_DIR}/versions/node/$(nvm ls 22 --no-colors 2>/dev/null | head -1 | tr -d '[:space:]>*')/bin/node"
    fi
fi

if [ ! -x "${NODE_BIN}" ]; then
    echo "ERROR: Node.js 22+ not found" >&2
    exit 1
fi

# Initialize user config if missing
CONFIG_DIR="${HOME}/.naia"
if [ ! -f "${CONFIG_DIR}/openclaw.json" ]; then
    mkdir -p "${CONFIG_DIR}"
    cat > "${CONFIG_DIR}/openclaw.json" <<'CONF'
{
  "gateway": {
    "mode": "local",
    "port": 18789,
    "bind": "loopback",
    "auth": { "mode": "token" }
  },
  "agents": {
    "defaults": {
      "workspace": "~/.naia/workspace"
    }
  }
}
CONF
fi

export OPENCLAW_CONFIG_PATH="${CONFIG_DIR}/openclaw.json"

# Run gateway
exec "${NODE_BIN}" "${OPENCLAW_BIN}" gateway run \
    --bind loopback \
    --port 18789
